<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="FinanceBuddy.Expenses.ExpensesPage"
             xmlns:viewmodel="clr-namespace:FinanceBuddy.Expenses"
             xmlns:models="clr-namespace:FinanceBuddy.Models"
             xmlns:resources="clr-namespace:FinanceBuddy.Resources"
             x:DataType="viewmodel:ExpensesViewModel"
             Title="Expenses"
             BackgroundColor="#F5F5F5">

    <Grid>
        <!-- Main Content Grid -->
        <Grid RowDefinitions="Auto,*"
                Padding="16">

            <!-- Month/Total Summary Card -->
            <Border Grid.Row="0"
                    BackgroundColor="White"
                    StrokeThickness="0"
                    Padding="20"
                    Margin="0,0,0,16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>
                <Border.Shadow>
                    <Shadow Brush="Black"
                            Opacity="0.1"
                            Radius="8"
                            Offset="0,2"/>
                </Border.Shadow>

                <VerticalStackLayout Spacing="8">
                    <Label Text="{Binding CurrentMonth}"
                           FontSize="16"
                           TextColor="#49454F"
                           HorizontalOptions="Center"/>

                    <Label FontSize="40"
                           FontAttributes="Bold"
                           TextColor="#1C1B1F"
                           HorizontalOptions="Center">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="€"/>
                                <Span Text="{Binding TotalSpent, StringFormat='{0:N2}'}"/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>

                    <Label Text="Total spent this month"
                           FontSize="14"
                           TextColor="#49454F"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Border>

            <!-- Expenses List -->
            <CollectionView Grid.Row="1"
                            ItemsSource="{Binding Expenses}"
                            VerticalScrollBarVisibility="Never"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Expense">
                        <Border BackgroundColor="White"
                                StrokeThickness="0"
                                Margin="0,0,0,12"
                                Padding="16">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12"/>
                            </Border.StrokeShape>
                            <Border.Shadow>
                                <Shadow Brush="Black"
                                        Opacity="0.05"
                                        Radius="4"
                                        Offset="0,1"/>
                            </Border.Shadow>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExpensesViewModel}}, Path=ViewExpenseDetailsCommand}"
                                                      CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>

                            <Grid ColumnDefinitions="Auto,*,Auto"
                                    ColumnSpacing="12">
                                <!-- Category Icon -->
                                <Border Grid.Column="0"
                                        BackgroundColor="{Binding Category.IconColor}"
                                        WidthRequest="48"
                                        HeightRequest="48"
                                        StrokeThickness="0">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="24"/>
                                    </Border.StrokeShape>

                                    <Label Text="{Binding Category.Icon}"
                                           FontFamily="MaterialSymbolsOutlined"
                                           FontSize="24"
                                           TextColor="#1C1B1F"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                </Border>

                                <!-- Expense Name and Date -->
                                <VerticalStackLayout Grid.Column="1"
                                        Spacing="4"
                                        VerticalOptions="Center">
                                    <Label Text="{Binding Name}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="#1C1B1F"/>

                                    <Label FontSize="14"
                                           TextColor="#49454F">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span Text="{Binding Date, StringFormat='{0:MMM dd, h:mm tt}'}"/>
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </VerticalStackLayout>

                                <!-- Amount -->
                                <Label Grid.Column="2"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="#1C1B1F"
                                       VerticalOptions="Center">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="-€"/>
                                            <Span Text="{Binding Amount, StringFormat='{0:N2}'}"/>
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- Floating Action Button -->
        <ImageButton HorizontalOptions="End"
                     VerticalOptions="End"
                     BackgroundColor="#6750A4"
                     CornerRadius="28"
                     HeightRequest="56" WidthRequest="56"
                     Margin="20"
                     Command="{Binding NavigateToAddExpenseCommand}"
                     Shadow="{Shadow Brush=Black, Opacity=0.3, Radius=8, Offset='0,4'}"
                     InputTransparent="False">
            <ImageButton.Source>
                <FontImageSource FontFamily="MaterialSymbolsOutlined"
                                 Glyph="{x:Static resources:Icons.Add}"
                                 Color="White"
                                 Size="32"/>
            </ImageButton.Source>
        </ImageButton>
    </Grid>
</ContentPage>
